# /etc/nginx/conf.d/default.conf

server {
  listen 80;
  server_name _;

  # Static assets
  root /usr/share/nginx/html;
  index index.html;

  # front page
  location = / {
    try_files $uri /index.html;
  }

  # JS bundle
  location /main.js {
    try_files $uri =404;
    add_header Cache-Control "no-store";
  }

  # ---------- API PROXIES ----------
  # Use ^~ to prefer these prefix matches over the generic prefix locations,
  # and include trailing slash in proxy_pass so the path is preserved.

  location ^~ /customers/ {
    proxy_pass         http://customer-service-w08e1:8002/;
    proxy_http_version 1.1;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
  }

  location ^~ /products/ {
    proxy_pass         http://product-service-w08e1:8000/;
    proxy_http_version 1.1;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
  }

  location ^~ /orders/ {
    proxy_pass         http://order-service-w08e1:8001/;
    proxy_http_version 1.1;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
  }

  # Reasonable defaults
  client_max_body_size 10m;
  sendfile on;
  tcp_nopush on;
  keepalive_timeout  65;

  # Optional: simple CORS for APIs (uncomment if your browser complains)
  # add_header Access-Control-Allow-Origin "*"  always;
  # add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
  # add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
  # if ($request_method = OPTIONS) { return 204; }
}
